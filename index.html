USE [btprod];
GO
SET ANSI_NULLS ON;
GO
SET QUOTED_IDENTIFIER ON;
GO

/* =========================
   cwk_RefreshZipSalesDaily
   - Deletes the target date window first (prevents stale/duplicate keys)
   - Rebuilds aggregates for the window
   - Uses COUNT(DISTINCT DocumentID) so TicketCount is true “ticket” count (not line count)
   ========================= */
ALTER PROCEDURE [dbo].[cwk_RefreshZipSalesDaily]
    @StartDate date = NULL,          -- NULL = from earliest available
    @EndDate   date = NULL,          -- NULL = today
    @RecalcDaysBack int = 7          -- rolling window for late changes
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Today date = CONVERT(date, GETDATE());

    IF @EndDate IS NULL
        SET @EndDate = @Today;

    IF @StartDate IS NULL
    BEGIN
        -- First run: full history
        SELECT @StartDate = MIN(CONVERT(date, DocumentDate))
        FROM dbo.SalesAnalysis3;
    END
    ELSE
    BEGIN
        -- Normal run: back up a few days to catch late posting/edits
        SET @StartDate = DATEADD(day, -@RecalcDaysBack, @StartDate);
    END

    /* ==========================================================
       1) DELETE the target window first to prevent stale/duplicate rows
          (anything in this window will be rebuilt from scratch)
       ========================================================== */
    DELETE FROM dbo.cwk_ZipSalesDaily
    WHERE SaleDate >= @StartDate
      AND SaleDate <  DATEADD(day, 1, @EndDate);

    /* ==========================================================
       2) Rebuild aggregates for the window
       ========================================================== */
    ;WITH Agg AS (
        SELECT
            CONVERT(date, sa3.DocumentDate) AS SaleDate,
            sa3.BranchID,
            b.Name AS BranchName,
            z.Zip5 AS PostCode,
            pg.Level1 AS ProductGroupLevel1,

            COUNT(DISTINCT sa3.DocumentID) AS TicketCount,
            SUM(sa3.TotalSales) AS TotalSales,
            SUM(sa3.TotalSales - sa3.TotalCost) AS TotalProfit,
            CAST(SUM(sa3.TotalSales) AS decimal(18,2)) / NULLIF(COUNT(DISTINCT sa3.DocumentID), 0) AS AvgTicket,
            SUM(CASE WHEN z.UsedBranchFallback = 1 THEN 1 ELSE 0 END) AS FallbackToBranchCount
        FROM dbo.SalesAnalysis3 sa3
        INNER JOIN dbo.CustomerAddress ca
            ON ca.CustomerAddressID = sa3.CustomerAddressID
        LEFT JOIN dbo.Branch b
            ON b.BranchID = sa3.BranchID
        LEFT JOIN dbo.jrhProductGroup pg
            ON pg.ProductID = sa3.ProductID

        OUTER APPLY (
            SELECT
                caTrim = NULLIF(LTRIM(RTRIM(ca.PostCode)), ''),
                bTrim  = NULLIF(LTRIM(RTRIM(b.PostCode)), '')
        ) t

        OUTER APPLY (
            SELECT
                caZip5 =
                    CASE
                        WHEN LEFT(t.caTrim, 5) LIKE '[0-9][0-9][0-9][0-9][0-9]'
                            THEN LEFT(t.caTrim, 5)
                    END,
                bZip5 =
                    CASE
                        WHEN LEFT(t.bTrim, 5) LIKE '[0-9][0-9][0-9][0-9][0-9]'
                            THEN LEFT(t.bTrim, 5)
                    END
        ) z1

        OUTER APPLY (
            SELECT
                Zip5 = COALESCE(z1.caZip5, z1.bZip5),
                UsedBranchFallback = CASE WHEN z1.caZip5 IS NULL AND z1.bZip5 IS NOT NULL THEN 1 ELSE 0 END
        ) z

        WHERE
            sa3.DocumentDate >= @StartDate
            AND sa3.DocumentDate < DATEADD(day, 1, @EndDate)
            AND sa3.BranchID IS NOT NULL
            AND z.Zip5 IS NOT NULL
            AND pg.Level1 IS NOT NULL   -- keep rows clean; remove if you want Unknown bucket

        GROUP BY
            CONVERT(date, sa3.DocumentDate),
            sa3.BranchID,
            b.Name,
            z.Zip5,
            pg.Level1
    )
    INSERT INTO dbo.cwk_ZipSalesDaily (
        SaleDate,
        BranchID,
        BranchName,
        PostCode,
        ProductGroupLevel1,
        TicketCount,
        TotalSales,
        TotalProfit,
        AvgTicket,
        FallbackToBranchCount,
        LastUpdatedUtc
    )
    SELECT
        a.SaleDate,
        a.BranchID,
        a.BranchName,
        a.PostCode,
        a.ProductGroupLevel1,
        a.TicketCount,
        a.TotalSales,
        a.TotalProfit,
        a.AvgTicket,
        a.FallbackToBranchCount,
        SYSUTCDATETIME()
    FROM Agg a;

END;
GO
